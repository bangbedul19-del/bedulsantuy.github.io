<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>SaveFilePicker + document.location Race Tester</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    label { display: block; margin-top: 10px; }
    button { margin-top: 15px; padding: 8px 14px; }
    small { color: #555; }
  </style>
</head>
<body>

<h3>Save File Picker â€“ document.location Race Tester</h3>

<label>
  Pilih timeout (ms):
  <select id="delaySelect">
    <option value="0">0 ms (event-loop edge)</option>
    <option value="1">1 ms</option>
    <option value="50">50 ms</option>
    <option value="100" selected>100 ms</option>
    <option value="300">300 ms</option>
    <option value="500">500 ms</option>
  </select>
</label>

<label>
  Atau timeout manual (ms):
  <input type="number" id="delayInput" placeholder="contoh: 75" />
</label>

<button onclick="start()">Click to Start Test</button>

<small>
  <br>Target: redirect terjadi dulu, lalu Save File Picker dipanggil.
</small>

<script>
function getDelay() {
  const manual = document.getElementById("delayInput").value;
  if (manual !== "" && !isNaN(manual)) return parseInt(manual, 10);
  return parseInt(document.getElementById("delaySelect").value, 10);
}

function start() {
  const delay = getDelay();
  console.log("Using delay:", delay, "ms");

  // 1) Jadwalkan redirect lebih dulu
  setTimeout(() => {
    console.log("Redirecting now");
    document.location = "https://www.google.com";
  }, 0);

  // 2) Tunda pemanggilan Save File Picker
  setTimeout(async () => {
    console.log("Calling showSaveFilePicker()");
    try {
      await window.showSaveFilePicker({
        suggestedName: "test.txt",
        types: [{
          description: "Text Files",
          accept: { "text/plain": [".txt"] }
        }]
      });
      console.log("Picker resolved");
    } catch (e) {
      console.log("Picker rejected/canceled:", e);
    }
  }, delay);
}
</script>

</body>
</html>
